<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitMazon</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"/>
</head>
<body>
<h1> Create Service</h1>
<form id="serviceForm">
    <label for="username">Username:</label><br>
    <input type="text" id="username" name="username" required><br><br>

    <label for="serviceName">Service Name:</label><br>
    <input type="text" id="serviceName" name="serviceName" required><br><br>

    <label for="repoUrl">GitHub Repo URL:</label><br>
    <input type="url" id="repoUrl" name="repoUrl" required><br><br>

    <input type="submit" value="提交">
</form>

<p id="result"></p>

<!-- 服務列表 -->
<h2>您的服務列表</h2>
<div id="serviceList">
    <!-- 這裡會動態填入服務項目 -->
</div>

<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<script>
    document.getElementById("serviceForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        const username = document.getElementById("username").value;
        const serviceName = document.getElementById("serviceName").value;
        const repoUrl = document.getElementById("repoUrl").value;

        const requestData = {
            username: username,
            serviceName: serviceName,
            repoUrl: repoUrl
        };

        try {
            const response = await fetch("http://52.69.33.14:8082/registerService", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();
            document.getElementById("result").innerText = `您的服務網址是 ${data.serviceUrl}，並會在幾分鐘之內啟動。`;

            await fetchUserServices(username);

        } catch (error) {
            console.error("Error:", error);
            document.getElementById("result").innerText = "註冊失敗，請重試。";
        }
    });

    function addServiceToList(username, serviceName, repoName, endpoint) {
        const serviceList = document.getElementById("serviceList");

        const serviceItem = document.createElement("div");
        serviceItem.innerHTML = `
        <p><strong>使用者名稱:</strong> ${username}</p>
        <p><strong>服務名稱:</strong> ${serviceName}</p>
        <p><strong>Repo 名稱:</strong> ${repoName}</p>
        <p><strong>服務網址:</strong> ${endpoint}</p>
        <button class="sshButton" data-username="${username}" data-service-name="${serviceName}" data-repo-name="${repoName}">SSH</button>
        <div class="terminal-container" style="display:none;">
            <div id="terminal-${username}-${serviceName}" style="height: 400px; width: 100%;"></div>
        </div>
    `;
        serviceList.appendChild(serviceItem);


        // Bind ssh button to
        serviceItem.querySelector(".sshButton").addEventListener("click", function () {
            const terminalContainer = serviceItem.querySelector(".terminal-container");
            terminalContainer.style.display = 'block';

            const terminalElement = terminalContainer.querySelector(`#terminal-${username}-${serviceName}`);
            openWebTerminal(terminalElement, username, repoName);
        });
    }


    function openWebTerminal(terminalElement, username, repoName) {
        const term = new Terminal();
        term.open(terminalElement);

        const socket = new WebSocket(`ws://${window.location.host}/terminal?username=${username}&repoName=${repoName}`);

        term.onData(function (data) {
            socket.send(data);
        });

        socket.onmessage = (event) => {
            term.write(event.data);
        };

        socket.onerror = (error) => {
            console.error("WebSocket error: ", error);
        };
    }

    async function fetchUserServices(username) {
        try {
            const response = await fetch(`http://52.69.33.14:8082/userService?username=${username}`);
            const services = await response.json();

            const serviceList = document.getElementById("serviceList");
            serviceList.innerHTML = "";

            services.forEach(service => {
                addServiceToList(service.username, service.serviceName, service.repoName, service.endpoint);
            });
        } catch (error) {
            console.error("Error fetching services:", error);
        }
    }


</script>
</body>
</html>
